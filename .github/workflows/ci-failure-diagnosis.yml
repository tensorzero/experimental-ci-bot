name: TensorZero CI Bot

on:
  workflow_run:
    workflows: ['Continuous Integration']
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  gather-diff-and-generate-patch:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    name: Gather failure context and generate PR
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.CI_BOT_TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.CI_BOT_TS_OAUTH_CLIENT_SECRET }}
          tags: tag:ci
          args: --verbose=2

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          fetch-tags: false

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install mini-swe-agent
        run:
          uv tool install mini-swe-agent --from
          "git+https://github.com/virajmehta/mini-swe-agent.git@main"

      - name: Call LLM to generate PR revision
        # TODO: currently pinned to miniswe-agent branch; switch back to main when ready.
        uses: tensorzero/experimental-ci-bot/generate-pr-patch@viraj/pr-only
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tensorzero-base-url: http://localhost:3000
          # TODO: Remove when agent creates PRs
          tensorzero-diff-patched-successfully-metric-name: tensorzero_github_ci_bot_diff_patched_successfully
          output-artifacts-dir: debug-logs
          clickhouse-url: ${{ secrets.CI_BOT_CLICKHOUSE_URL }}
          clickhouse-table: GitHubBotPullRequestToInferenceMap

      - name: Upload diagnostics bundle
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: ci-failure-diagnostics
          path: |
            debug-logs/
